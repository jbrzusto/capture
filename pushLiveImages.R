dyn.load("capture_lib.so") 
library(RSQLite)
library(png)
con = dbConnect("SQLite", "/mnt/3tb/force_data/force2013-11-20T14-38-42.723.sqlite")
pix = matrix(0L, 1024, 1024)
class(pix)="nativeRaster"
attr(pix, "channels") = 4
## pal = c(-16580608L, -16187392L, -15859712L, -15466496L, -15073280L,  -14680064L, -14286848L, -13893632L, -13500416L, -13107200L, -12713984L,  -12320768L, -11927552L, -11534336L, -11141120L, -10747904L, -10354688L,  -9961472L, -9568256L, -9240576L, -8847360L, -8454144L, -8060928L,  -7667712L, -7274496L, -6881280L, -6488064L, -6094848L, -5701632L,  -5308416L, -4915200L, -4521984L, -4128768L, -3735552L, -3342336L,  -3014656L, -2621440L, -2228224L, -1835008L, -1441792L, -1048576L,  -655360L, -262144L, -65024L, -64000L, -62976L, -61696L, -60672L,  -59648L, -58624L, -57600L, -56320L, -55296L, -54272L, -53248L,  -52224L, -50944L, -49920L, -48896L, -47872L, -46848L, -45824L,  -44544L, -43520L, -42496L, -41472L, -40448L, -39168L, -38144L,  -37120L, -36096L, -35072L, -33792L, -32768L, -31744L, -30720L,  -29696L, -28672L, -27392L, -26368L, -25344L, -24320L, -23296L,  -22016L, -20992L, -19968L, -18944L, -17920L, -16640L, -15616L,  -14592L, -13568L, -12544L, -11520L, -10240L, -9216L, -8192L,  -7168L, -6144L, -4864L, -3840L, -2816L, -1792L, -768L, -262400L,  -786688L, -1245440L, -1769728L, -2228480L, -2687232L, -3211520L,  -3670272L, -4129024L, -4653312L, -5112064L, -5570816L, -6095104L,  -6553856L, -7078144L, -7536896L, -7995648L, -8519936L, -8978688L,  -9437440L, -9961728L, -10420480L, -10879232L, -11403520L, -11862272L,  -12386560L, -12845312L, -13304064L, -13828352L, -14287104L, -14745856L,  -15270144L, -15728896L, -16253184L, -16711936L, -16712442L, -16712691L,  -16713197L, -16713703L, -16714208L, -16714458L, -16714963L, -16715469L,  -16715719L, -16716224L, -16716730L, -16716979L, -16717485L, -16717991L,  -16718496L, -16718746L, -16719251L, -16719757L, -16720007L, -16720512L,  -16721018L, -16721267L, -16721773L, -16722279L, -16722784L, -16723034L,  -16723539L, -16724045L, -16724295L, -16724800L, -16725306L, -16725811L,  -16726061L, -16726567L, -16727072L, -16727322L, -16727827L, -16728333L,  -16728583L, -16729089L, -16729857L, -16730369L, -16731137L, -16731649L,  -16732161L, -16732929L, -16733441L, -16734209L, -16734721L, -16735233L,  -16736001L, -16736513L, -16737281L, -16737793L, -16738305L, -16739073L,  -16739585L, -16740353L, -16740865L, -16741377L, -16742145L, -16742657L,  -16743425L, -16743937L, -16744705L, -16745217L, -16745729L, -16746497L,  -16747009L, -16747777L, -16748289L, -16748801L, -16749569L, -16750081L,  -16750849L, -16751361L, -16751873L, -16752641L, -16753153L, -16753921L,  -16754433L, -16755201L, -16755713L, -16756225L, -16756993L, -16757505L,  -16758273L, -16758785L, -16759297L, -16760065L, -16760577L, -16761345L,  -16761857L, -16762369L, -16763137L, -16763649L, -16764417L, -16764929L,  -16765697L, -16766209L, -16766721L, -16767489L, -16768001L, -16768769L,  -16769281L, -16769793L, -16770561L, -16771073L, -16771841L, -16772353L,  -16772865L, -16773633L, -16774145L, -16774913L, -16775425L, -16776193L,  -16776705L)
## pal=c(196608L, 34144256L, 68026368L, 101974016L, 135921664L, 169869312L,  203816960L, 237764608L, 271712256L, 305659904L, 339607552L, 373555200L,  407502848L, 441450496L, 475398144L, 509345792L, 543293440L, 577241088L,  611188736L, 645070848L, 679018496L, 712966144L, 746913792L, 780861440L,  814809088L, 848756736L, 882704384L, 916652032L, 950599680L, 984547328L,  1018494976L, 1052442624L, 1086390272L, 1120337920L, 1154285568L,  1188167680L, 1222115328L, 1256062976L, 1290010624L, 1323958272L,  1357905920L, 1391853568L, 1425801216L, 1459552768L, 1493108224L,  1526663680L, 1560219392L, 1593774848L, 1627330304L, 1660885760L,  1694441216L, 1727996928L, 1761552384L, 1795107840L, 1828663296L,  1862218752L, 1895774464L, 1929329920L, 1962885376L, 1996440832L,  2029996288L, 2063551744L, 2097107456L, 2130662912L, NA, -2097193472L,  -2063638016L, -2030082304L, -1996526848L, -1962971392L, -1929415936L,  -1895860480L, -1862304768L, -1828749312L, -1795193856L, -1761638400L,  -1728082944L, -1694527488L, -1660971776L, -1627416320L, -1593860864L,  -1560305408L, -1526749952L, -1493194240L, -1459638784L, -1426083328L,  -1392527872L, -1358972416L, -1325416704L, -1291861248L, -1258305792L,  -1224750336L, -1191194880L, -1157639424L, -1124083712L, -1090528256L,  -1056972800L, -1023417344L, -989861888L, -956306176L, -922750720L,  -889195264L, -855639808L, -822084352L, -788791552L, -755761408L,  -722665728L, -689635584L, -656539904L, -623444224L, -590414080L,  -557318400L, -524222720L, -491192576L, -458096896L, -425001216L,  -391971072L, -358875392L, -325845248L, -292749568L, -259653888L,  -226623744L, -193528064L, -160432384L, -127402240L, -94306560L,  -61210880L, -28180736L, -11862272L, -12386560L, -12845312L, -13304064L,  -13828352L, -14287104L, -14745856L, -15270144L, -15728896L, -16253184L,  -16711936L, -16712442L, -16712691L, -16713197L, -16713703L, -16714208L,  -16714458L, -16714963L, -16715469L, -16715719L, -16716224L, -16716730L,  -16716979L, -16717485L, -16717991L, -16718496L, -16718746L, -16719251L,  -16719757L, -16720007L, -16720512L, -16721018L, -16721267L, -16721773L,  -16722279L, -16722784L, -16723034L, -16723539L, -16724045L, -16724295L,  -16724800L, -16725306L, -16725811L, -16726061L, -16726567L, -16727072L,  -16727322L, -16727827L, -16728333L, -16728583L, -16729089L, -16729857L,  -16730369L, -16731137L, -16731649L, -16732161L, -16732929L, -16733441L,  -16734209L, -16734721L, -16735233L, -16736001L, -16736513L, -16737281L,  -16737793L, -16738305L, -16739073L, -16739585L, -16740353L, -16740865L,  -16741377L, -16742145L, -16742657L, -16743425L, -16743937L, -16744705L,  -16745217L, -16745729L, -16746497L, -16747009L, -16747777L, -16748289L,  -16748801L, -16749569L, -16750081L, -16750849L, -16751361L, -16751873L,  -16752641L, -16753153L, -16753921L, -16754433L, -16755201L, -16755713L,  -16756225L, -16756993L, -16757505L, -16758273L, -16758785L, -16759297L,  -16760065L, -16760577L, -16761345L, -16761857L, -16762369L, -16763137L,  -16763649L, -16764417L, -16764929L, -16765697L, -16766209L, -16766721L,  -16767489L, -16768001L, -16768769L, -16769281L, -16769793L, -16770561L,  -16771073L, -16771841L, -16772353L, -16772865L, -16773633L, -16774145L,  -16774913L, -16775425L, -16776193L, -16776705L)

pal = c(-16580608L, -16187392L, -15859712L, -15466496L, -15073280L,  -14680064L, -14286848L, -13893632L, -13500416L, -13107200L, -12713984L,  -12320768L, -11927552L, -11534336L, -11141120L, -10747904L, -10354688L,  -9961472L, -9568256L, -9240576L, -8847360L, -8454144L, -8060928L,  -7667712L, -7274496L, -6881280L, -6488064L, -6094848L, -5701632L,  -5308416L, -4915200L, -4521984L, 12648448L, 46596096L, 80543744L,  114425856L, 148373504L, 182321152L, 216268800L, 250216448L, 284164096L,  318111744L, 352059392L, 385810944L, 419366400L, 452921856L, 486477568L,  520033024L, 553588480L, 587143936L, 620699392L, 654255104L, 687810560L,  721366016L, 754921472L, 788476928L, 822032640L, 855588096L, 889143552L,  922699008L, 956254464L, 989809920L, 1023365632L, 1056921088L,  1090476544L, 1124032000L, 1157587456L, 1191143168L, 1224698624L,  1258254080L, 1291809536L, 1325364992L, 1358920704L, 1392476160L,  1426031616L, 1459587072L, 1493142528L, 1526697984L, 1560253696L,  1593809152L, 1627364608L, 1660920064L, 1694475520L, 1728031232L,  1761586688L, 1795142144L, 1828697600L, 1862253056L, 1895808768L,  1929364224L, 1962919680L, 1996475136L, 2030030592L, 2063586048L,  2097141760L, 2130697216L, NA, -2097159168L, -2063603712L, -2030048000L,  -1996492544L, -1962937088L, -1929381632L, -1895826176L, -1862533376L,  -1829503232L, -1796407552L, -1763377408L, -1730281728L, -1697186048L,  -1664155904L, -1631060224L, -1597964544L, -1564934400L, -1531838720L,  -1498743040L, -1465712896L, -1432617216L, -1399587072L, -1366491392L,  -1333395712L, -1300365568L, -1267269888L, -1234174208L, -1201144064L,  -1168048384L, -1134952704L, -1101922560L, -1068826880L, -1035796736L,  -1002701056L, -969605376L, -936575232L, -903479552L, -870383872L,  -837353728L, -804258048L, -771227904L, -738132224L, -704578298L,  -671024115L, -637470189L, -603916263L, -570362336L, -536808154L,  -503254227L, -469700301L, -436146119L, -402592192L, -369038266L,  -335484083L, -301930157L, -268376231L, -234822304L, -201268122L,  -167714195L, -134160269L, -100606087L, -67052160L, -33498234L,  -16721267L, -16721773L, -16722279L, -16722784L, -16723034L, -16723539L,  -16724045L, -16724295L, -16724800L, -16725306L, -16725811L, -16726061L,  -16726567L, -16727072L, -16727322L, -16727827L, -16728333L, -16728583L,  -16729089L, -16729857L, -16730369L, -16731137L, -16731649L, -16732161L,  -16732929L, -16733441L, -16734209L, -16734721L, -16735233L, -16736001L,  -16736513L, -16737281L, -16737793L, -16738305L, -16739073L, -16739585L,  -16740353L, -16740865L, -16741377L, -16742145L, -16742657L, -16743425L,  -16743937L, -16744705L, -16745217L, -16745729L, -16746497L, -16747009L,  -16747777L, -16748289L, -16748801L, -16749569L, -16750081L, -16750849L,  -16751361L, -16751873L, -16752641L, -16753153L, -16753921L, -16754433L,  -16755201L, -16755713L, -16756225L, -16756993L, -16757505L, -16758273L,  -16758785L, -16759297L, -16760065L, -16760577L, -16761345L, -16761857L,  -16762369L, -16763137L, -16763649L, -16764417L, -16764929L, -16765697L,  -16766209L, -16766721L, -16767489L, -16768001L, -16768769L, -16769281L,  -16769793L, -16770561L, -16771073L, -16771841L, -16772353L, -16772865L,  -16773633L, -16774145L, -16774913L, -16775425L, -16776193L, -16776705L )


a = .Call("make_scan_converter", c(3800L, 1024L, 1024L, 1024L, 0L, 0L, 512L, 512L), c(0.5, -0.523, 0))

last.sk = -1
while (TRUE) {
  Sys.sleep(0.1)
  ts = .Call("get_latest_pulse_timestamp")
  sk = dbGetQuery(con, sprintf("select sweep_key from pulses where ts <= %f order by ts desc limit 1", ts))[1, 1] - 1
  if (sk == last.sk || sk < 1)
    next
  last.sk = sk
  x = dbGetQuery(con, sprintf("select * from pulses where sweep_key = %d order by ts limit 3800", sk))
  options(digits=14)
  cat(ts, file="FORCERadarTimestamp.txt")
  b = unlist(x$samples)
  .Call("apply_scan_converter", a, b, pix, pal, c(1024L, 4L))
#  print(ts)
  writePNG(pix, "currentFORCERadarImage.png")
  system("scp -q currentFORCERadarImage.png force-radar@discovery:/home/www/html/htdocs/force/")
  system("scp -q FORCERadarTimestamp.txt force-radar@discovery:/home/www/html/htdocs/force/")
  system("ssh force-radar@discovery mv -f /home/www/html/htdocs/force/currentFORCERadarImage.png /home/www/html/htdocs/force/FORCERadarImage.png")
}
